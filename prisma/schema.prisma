generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// Менеджеры отдела продаж
model User {
  id              String    @id @default(cuid())
  email           String    @unique
  password        String
  name            String
  role            String    @default("MANAGER")
  avatar          String?
  isOnline        Boolean   @default(false)
  lastSeenAt      DateTime?
  mangoExtension  String?   // Внутренний номер в Mango Office (например "101")
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Связи
  contacts      Contact[]
  deals         Deal[]
  messages      Message[]
  calls         Call[]
  dealComments  DealComment[]

  @@map("users")
}

// Контакты/Лиды
model Contact {
  id              String    @id @default(cuid())
  name            String
  phone           String?
  email           String?
  telegramId      String?   @unique
  telegramUsername String?
  source          String?
  status          String    @default("NEW")
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Связи
  managerId       String?
  manager         User?     @relation(fields: [managerId], references: [id])
  deals           Deal[]
  messages        Message[]
  calls           Call[]

  @@map("contacts")
}

// Воронки продаж
model Pipeline {
  id        String   @id @default(cuid())
  name      String   @unique
  slug      String   @unique
  icon      String?
  order     Int      @default(0)
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Связи
  deals     Deal[]
  stages    PipelineStage[]

  @@map("pipelines")
}

// Этапы воронок
model PipelineStage {
  id         String   @id @default(cuid())
  name       String
  slug       String
  color      String
  order      Int      @default(0)
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Связи
  pipelineId String
  pipeline   Pipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)

  @@unique([pipelineId, slug])
  @@map("pipeline_stages")
}

// Этапы сделок (deprecated - будет удалено)
model Stage {
  id        String   @id @default(cuid())
  name      String
  color     String
  order     Int      @default(0)
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("stages")
}

// Сделки
model Deal {
  id          String      @id @default(cuid())
  title       String
  amount      Float       @default(0)
  stage       String      @default("NEW")
  probability Int         @default(50)
  description String?
  order       Int         @default(0)
  closedAt    DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Связи
  pipelineId  String?
  pipeline    Pipeline?   @relation(fields: [pipelineId], references: [id])
  contactId   String?
  contact     Contact?    @relation(fields: [contactId], references: [id])
  managerId   String?
  manager     User?       @relation(fields: [managerId], references: [id])
  comments    DealComment[]
  calls       Call[]

  @@map("deals")
}

// Комментарии и активность по сделкам
model DealComment {
  id              String    @id @default(cuid())
  content         String
  type            String    // 'COMMENT' | 'SYSTEM_EVENT' | 'TELEGRAM_MESSAGE'
  eventType       String?   // 'STAGE_CHANGED' | 'CALL_INCOMING' | 'CALL_OUTGOING' | etc
  metadata        String?   // JSON с дополнительными данными события
  sentToTelegram  Boolean   @default(false)
  createdAt       DateTime  @default(now())

  // Связи
  dealId          String
  deal            Deal      @relation(fields: [dealId], references: [id], onDelete: Cascade)
  userId          String?
  user            User?     @relation(fields: [userId], references: [id])

  @@map("deal_comments")
}

// Сообщения (Telegram и чат)
model Message {
  id              String        @id @default(cuid())
  content         String
  type            String        @default("TEXT")
  direction       String
  telegramMsgId   Int?
  isRead          Boolean       @default(false)
  createdAt       DateTime      @default(now())

  // Связи
  contactId       String
  contact         Contact       @relation(fields: [contactId], references: [id])
  managerId       String?
  manager         User?         @relation(fields: [managerId], references: [id])

  // Файлы/медиа
  attachments     Attachment[]

  @@map("messages")
}

// Вложения к сообщениям
model Attachment {
  id          String    @id @default(cuid())
  filename    String
  url         String
  mimeType    String?
  size        Int?
  createdAt   DateTime  @default(now())

  messageId   String
  message     Message   @relation(fields: [messageId], references: [id])

  @@map("attachments")
}

// Звонки (Mango Office)
model Call {
  id              String        @id @default(cuid())
  externalId      String?       @unique  // entry_id из Mango
  mangoCallId     String?       @unique  // call_id из Mango
  direction       String        // IN | OUT
  phone           String?       // Номер клиента (deprecated, используйте fromNumber/toNumber)
  fromNumber      String?       // Номер звонящего
  toNumber        String?       // Номер принимающего
  duration        Int?          @default(0) // Длительность в секундах
  status          String        @default("INITIATED") // INITIATED | RINGING | CONNECTED | COMPLETED | MISSED | BUSY
  result          String?       // Результат звонка
  recordingUrl    String?       // URL или ID записи
  createdAt       DateTime      @default(now())
  startTime       DateTime?     // Время начала звонка
  connectedTime   DateTime?     // Время соединения
  answeredAt      DateTime?     // Время ответа (deprecated, используйте connectedTime)
  endTime         DateTime?     // Время завершения
  endedAt         DateTime?     // Время завершения (deprecated, используйте endTime)

  // Связи
  contactId       String?
  contact         Contact?      @relation(fields: [contactId], references: [id])
  dealId          String?
  deal            Deal?         @relation(fields: [dealId], references: [id])
  managerId       String?
  manager         User?         @relation(fields: [managerId], references: [id])
  transcription   CallTranscription?

  @@map("calls")
}

// Транскрибация звонков
model CallTranscription {
  id          String    @id @default(cuid())
  text        String
  summary     String?
  sentiment   String?
  keywords    String
  createdAt   DateTime  @default(now())

  callId      String    @unique
  call        Call      @relation(fields: [callId], references: [id])

  @@map("call_transcriptions")
}

// Настройки интеграций
model Integration {
  id          String    @id @default(cuid())
  type        String
  config      String
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("integrations")
}

// Задачи и напоминания
model Task {
  id            String    @id @default(cuid())
  title         String
  description   String?
  type          String    @default("CALL") // CALL, MEETING, TODO, OTHER
  status        String    @default("PENDING") // PENDING, COMPLETED, CANCELLED
  dueDate       DateTime  // Дата и время напоминания
  reminderSent  Boolean   @default(false)
  completedAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Связи
  dealId        String?
  contactId     String?
  userId        String?

  @@map("tasks")
}

// Сотрудники (Зарплатный проект)
model Employee {
  id               String   @id @default(cuid())
  name             String              // ФИО
  position         String?             // должность
  officialSalary   Float    @default(0) // белая ЗП (оклад)
  unofficialSalary Float    @default(0) // чёрная ЗП
  salesCommissionPercent Float @default(0) // % комиссии от продаж
  businessUnitId   String?             // привязка к направлению
  businessUnit     BusinessUnit? @relation(fields: [businessUnitId], references: [id])
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  payments         SalaryPayment[]
  salesRecords     FinanceRecord[]     // доходы, где этот сотрудник — менеджер

  @@map("employees")
}

// Выплаты зарплат (привязка к календарю)
model SalaryPayment {
  id         String   @id @default(cuid())
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  amount     Float               // фактическая сумма выплаты
  salaryType String              // "OFFICIAL" | "UNOFFICIAL"
  date       DateTime            // дата выплаты (10-е или 25-е)
  isPaid     Boolean  @default(false)
  comment    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("salary_payments")
}

// Займы, кредиты, лизинги
model Loan {
  id             String   @id @default(cuid())
  name           String              // "Кредит Сбер", "Лизинг авто", "Займ от ИП"
  loanType       String              // "CREDIT" | "LEASING" | "LOAN"
  totalAmount    Float               // общая сумма займа
  remainingAmount Float              // остаток долга
  monthlyPayment Float               // ежемесячный платёж
  interestRate   Float?              // ставка %
  paymentDay     Int      @default(1) // число месяца оплаты
  startDate      DateTime            // дата оформления
  endDate        DateTime?           // дата окончания
  creditor       String?             // кредитор (банк, лизинговая компания, ФИО)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  payments       LoanPayment[]

  @@map("loans")
}

// Платежи по займам
model LoanPayment {
  id       String   @id @default(cuid())
  loanId   String
  loan     Loan     @relation(fields: [loanId], references: [id], onDelete: Cascade)
  amount   Float
  date     DateTime
  isPaid   Boolean  @default(false)
  comment  String?
  createdAt DateTime @default(now())

  @@map("loan_payments")
}

// Бизнес-направления (P&L)
model BusinessUnit {
  id        String   @id @default(cuid())
  name      String                // "Агентство Первый Селлер", "Банкротство"...
  order     Int      @default(0)
  createdAt DateTime @default(now())
  records   FinanceRecord[]
  employees Employee[]

  @@map("business_units")
}

// Категории финансов (P&L)
model FinanceCategory {
  id        String   @id @default(cuid())
  name      String                // "Зарплата чёрная", "Аренда", "Реклама"...
  type      String                // "INCOME" | "EXPENSE"
  group     String?               // "SALARY" | "ADMIN" | "MANDATORY" | "MARKETING" | "OTHER"
  order     Int      @default(0)
  createdAt DateTime @default(now())
  records   FinanceRecord[]

  @@map("finance_categories")
}

// Записи финансов (P&L)
model FinanceRecord {
  id          String   @id @default(cuid())
  amount      Float
  type        String              // "INCOME" | "EXPENSE"
  description String?
  date        DateTime            // дата операции
  dueDate     DateTime?           // дата оплаты (для платёжного календаря)
  isPaid      Boolean  @default(true)
  counterparty String?            // контрагент (кому должны / кто должен нам)
  debtType     String?            // "RECEIVABLE" (нам должны) | "PAYABLE" (мы должны) | null (обычная запись)
  client       String?            // клиент/компания (для доходных записей)
  salesManagerId String?          // менеджер по продажам
  salesManager   Employee? @relation(fields: [salesManagerId], references: [id], onDelete: SetNull)
  categoryId  String
  category    FinanceCategory @relation(fields: [categoryId], references: [id])
  businessUnitId String?
  businessUnit   BusinessUnit? @relation(fields: [businessUnitId], references: [id])
  userId      String?             // кто создал запись
  source      String   @default("MANUAL") // "MANUAL" | "BANK" | "EXCEL" | "TELEGRAM"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("finance_records")
}
