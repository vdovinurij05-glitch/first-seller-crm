import 'dotenv/config'
import { bot } from '../src/services/telegram'

const TELEGRAM_BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN

if (!TELEGRAM_BOT_TOKEN || TELEGRAM_BOT_TOKEN === 'YOUR_TELEGRAM_BOT_TOKEN') {
  console.error('âŒ TELEGRAM_BOT_TOKEN Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ¸Ğ»Ğ¸ Ğ½Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½ Ğ² .env Ñ„Ğ°Ğ¹Ğ»Ğµ')
  console.error('ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚Ğµ Ñ‚Ğ¾ĞºĞµĞ½ Ñƒ @BotFather Ğ² Telegram')
  process.exit(1)
}

async function startPolling() {
  try {
    console.log('ğŸš€ Ğ—Ğ°Ğ¿ÑƒÑĞº Telegram Ğ±Ğ¾Ñ‚Ğ° Ğ² polling Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ...')
    console.log('ğŸ“± Ğ¢Ğ¾ĞºĞµĞ½:', TELEGRAM_BOT_TOKEN!.substring(0, 10) + '...')

    // Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° ÑƒĞ´Ğ°Ğ»ÑĞµĞ¼ webhook ĞµÑĞ»Ğ¸ Ğ¾Ğ½ ĞµÑÑ‚ÑŒ
    console.log('ğŸ—‘ï¸  Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ webhook (ĞµÑĞ»Ğ¸ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½)...')
    await fetch(
      `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/deleteWebhook`,
      { method: 'POST' }
    )

    console.log('âœ… Webhook ÑƒĞ´Ğ°Ğ»ĞµĞ½')
    console.log('â³ Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ±Ğ¾Ñ‚Ğ°...')

    // Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ±Ğ¾Ñ‚Ğ°
    await bot.start()

    console.log('âœ… Ğ‘Ğ¾Ñ‚ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½!')
    console.log('ğŸ’¬ Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ñƒ Ğ² Telegram')
    console.log('ğŸ›‘ Ğ”Ğ»Ñ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Ctrl+C')
  } catch (error) {
    console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞºĞµ Ğ±Ğ¾Ñ‚Ğ°:', error)
    process.exit(1)
  }
}

// Graceful shutdown
process.once('SIGINT', () => {
  console.log('\nğŸ›‘ ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ±Ğ¾Ñ‚Ğ°...')
  bot.stop()
  process.exit(0)
})

process.once('SIGTERM', () => {
  console.log('\nğŸ›‘ ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ±Ğ¾Ñ‚Ğ°...')
  bot.stop()
  process.exit(0)
})

startPolling()
